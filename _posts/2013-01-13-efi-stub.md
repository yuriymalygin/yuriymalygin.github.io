---
title: Загрузка GNU/Linux без стороннего загрузчика
updated: 2013-01-13 14:50
---

<em>В данной статье я приведу пример, как можно отказаться от использования стороннего загрузчика, будь то Grub или Lilo, если ваш компьютер поддерживает современный стандарт UEFI, пришедший на замену BIOS. Интересной особенностью будет то, что все работы проводим на уже установленной и рабочей системе. По уровню сложности данная статья ориентирована на опытных пользователей Linux, т.к. некоторых моментов я касаюсь поверхностно, полагаясь на очевидность, чтобы не уходить от основной освещаемой темы.</em>

<h1>Введение</h1>
Расскажу немного истории — являюсь пользователем Gentoo Linux уже более 5 лет, причем как основной и единственной ОС на всех используемых мною ноутбуках: Lenovo (от X61s до X1) и Apple MacBook Pro. Всегда при новой инсталляции использовал классический метод установки Gentoo на чистый жесткий диск, с использованием chroot. Таблицу партиций и загрузку системы настраивал дедовским способом, как завещал Handbook, на основе традиционного MBR.
<h1>Настройка ядра</h1>
Необходимо обеспечить поддержку загрузки с использованием UEFI в нашем ядре:
<ul>
	<li><code>CONFIG_EFI=y</code> — включение поддержки стандарта UEFI</li>
	<li><code>CONFIG_EFI_STUB=y</code> — включение возможности загружать ядро прошивкой UEFI, то что нам и надо</li>
	<li><code>CONFIG_EFI_VARS=y</code> — включение интерфейса управления UEFI через переменные /sys/firmware/efi/vars/*, понадобится чтобы указать где искать ядро для загрузки, используется утилитой efibootmgr</li>
</ul>
При переходе на UEFI необходимо учесть то, что он не принимает параметры загрузки ядра, поэтому добавим все наши параметры в само ядро:
<pre>CONFIG_CMDLINE="root=/dev/sda2 rootfstype=ext4 quiet splash=silent,fadein,theme:natural_gentoo console=tty1"</pre>
В примере используемые мною параметры, если говорить о необходимом минимуме, то хватит и указания где находится корневая файловая система:
<pre>CONFIG_CMDLINE="root=/dev/sda2"</pre>
После внесения указанных изменений компилируем и устанавливаем ядро по обычной процедуре. В Gentoo для этого есть очень удобный инструмент под названием genkernel. После сборки нам потребуется перезагрузить компьютер, т.к. некоторые новые параметры нам нужны для работы с прошивкой UEFI.
<h1>Тестирование</h1>
Для проверки работоспособности нашего ядра нужно попробовать загрузить ОС через UEFI, но чтобы не рисковать загрузочным разделом нашей рабочей системы, мы будем использовать usb-флешку, предварительно удалив с нее все разделы.
<h2>Подготовка</h2>
Для загрузки средствами UEFI нам потребуется особый раздел, который называется EFI Secure Partition или сокращенно ESP, на котором будет лежать всего один файл — это подготовленное нами ранее ядро с поддержкой UEFI. По своей сути это обычный GPT раздел с определенным типом и файловой системой FAT32.
<h2>Создание ESP-партиции</h2>
Для создание ESP-раздела нам потребуется пакет gptfdisk, информация из пакетной базы Gentoo:
<pre><code>* sys-apps/gptfdisk
     Available versions:  0.8.4 ~0.8.5 {{kernel_linux}}
     Homepage:            http://www.rodsbooks.com/gdisk/
     Description:         gdisk - GPT partition table manipulator for Linux</code></pre>
Установить его можно выполнив команду с правами суперпользователя:
<pre>sudo emerge sys-apps/gptfdisk</pre>
Работа с данным инструментом почти ничем не отличается от всем знакомого fdisk. Допустим что наша usb-флешка определилась в системе как /dev/sdb и мы, конечно же, имеем права root'а. Выполняем следующие шаги:
<pre><code>sudo gdisk /dev/sdb

Command (? for help): n  
Partition number (2-128, default 1): 1  
First sector (34-3790814, default = 2048) or {+-}size{KMGTP}: 2048  
Last sector (2049-3790814, default = 3790814) or {+-}size{KMGTP}: +100M  
Current type is 'Linux filesystem'  
Hex code or GUID (L to show codes, Enter = 8300): EF00  
Changed type of partition to 'EFI System'

Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING  
PARTITIONS!!

Do you want to proceed? (Y/N): y  
OK; writing new GUID partition table (GPT) to /dev/sdb.  
The operation has completed successfully. </code></pre>
В результате мы создали новую партицию sdb1 с типом EFI System и размером 100 Мб, для тестирования этого вполне хватит. Теперь, как и с любой новой партицией, нам надо создать на ней файловую систему, в нашем случае это FAT32. Сделать очень просто — достаточно выполнить всего одну команду:
<pre>sudo mkfs.vfat -F 32 /dev/sdb1</pre>
После выполнения команды, файловая система будет создана.
<h2>Копирование ядра</h2>
Монтируем новую партицию sdb1 в любой каталог и копируем туда наше подготовленное ядро, с включенным CONFIG_EFI_STUB и другими параметрами описанными выше:
<pre>sudo mount /dev/sdb1 /mnt/ 
sudo cp /usr/src/linux/arch/x86_64/boot/bzImage /mnt/bzImage.efi 
sudo umount /dev/sdb1</pre>
<h2>Настройка BIOS</h2>
После подготовки тестовой usb-флешки необходимо перезагрузить компьютер и зайти в настройки BIOS и в разделе отвечающем за процесс загрузки выбрать использование UEFI. После чего загрузка системы должна пройти без каких-либо проблем, если ядро и флешка были подготовлены без ошибок. Тестирование можно считать пройденным и оставить систему загруженную с флешки.
<h1>Перенастройка загрузки на рабочей системе</h1>
По результатам пройденного выше теста, мы проверили что наше ядро корректно работает с прошивкой UEFI в нашем компьютере, поэтому приступим к миграции нашей рабочей системы на использование нового типа загрузки. Основная проблема в том что, система расположена на разделе созданном традиционной схемой разбиением на основе MBR (Master Boot Record), а для UEFI необходим GPT-раздел. Решается это проблема знакомым нам уже инструментом — gdisk из пакета sys-apps/gptfdisk. При первом запуске gdisk для нашего жесткого диска, пусть это будет /dev/sda, он предложит нам конвертировать таблицы разделов в формат GPT, предупредив о возможной потери данных. После чего проделаем все то что делали при создании usb-флешки, но с небольшими изменениями. С учетом вышесказанного, план работ будет выглядеть следующим образом:
<ul>
	<li>отключить загрузочный раздел</li>
	<li>сделать резервную копию раздела</li>
	<li>выполнить конвертацию MBR -&gt; GPT</li>
	<li>создать новую файловую систему на загрузочном разделе</li>
	<li>подключить к точке монтирования и скопировать ядро</li>
	<li>настроить прошивку UEFI</li>
	<li>перезагрузить систему и проверить результат</li>
</ul>
Далее остановимся на каждом пункте более подробно.
<h2>Отключить загрузочный раздел</h2>
В большинстве случаев загрузочный раздел подключен в каталог /boot и имеет первый номер среди партиций блочного устройства, т.е. /dev/sda1, с учетом того, что sda это наш системный диск. В моей системе все именно так, поэтому выполняем следующую команду:
<pre>sudo umount /boot</pre>
Если данный каталог не используется какими либо приложениями, то он молча и без проблем отключиться от корня и мы сможем выполнить резервное копирование всей партиции /dev/sda1.
<h2>Резервное копирование загрузочного раздела</h2>
На данном этапе нам необходимо сделать резервную копию всего раздела, чтобы иметь возможность быстро откатить все изменения. В идеальном случае можно выполнить бекап всей системы, если у вас есть под рукой необходимые инструменты. Копирование партиции выполняется следующим образом:
<pre>sudo dd if=/dev/sda1 of=sda1_backup.img</pre>
Проверим пригодность нашей резервной копии:
<pre>sudo mount -o loop sda1_backup.img /mnt &amp;&amp; ls -al /mnt &amp;&amp; sudo umount /mnt</pre>
После выполнения команды ls мы должны увидеть содержимое каталога аналогичное тому, что было в рабочей системе до отключения точки монтирования /boot.
<h2 id="mbrgpt">Конвертация таблицы MBR -&gt; GPT</h2>
Переходим к работе с утилитой <code>gdisk</code>. Весь процесс конвертации прост и требует минимум участия с нашей стороны. От нас необходимо запустить команду <code>gdisk</code>, сменить тип партиции <code>sda1</code> на <code>EF00 (EFI System)</code> и сохранить изменения, т.е. процедура полностью аналогична той что мы делали с usb-флешкой, за исключением того что партиции уже созданы. После сохранения настроек, наша таблица будет переведена в новый формат, используемый GPT и пригодный для работы с UEFI.

Создать новую файловую систему на новом загрузочном GPT-разделе

По аналогии с процедурой создания usb-флешки, нам надо подготовить файловую систему FAT32 на нашем загрузочном разделе, теперь уже типа 'EFI System', выполнив команду:
<pre><code>sudo mkfs.vfat -F 32 /dev/sda1  
</code></pre>
После выполнения команды, файловая система будет создана.
<h2>Копирование нового ядра</h2>
На данном этапе нам необходимо скопировать подготовленное ядро на новый раздел. Для этого выполните:
<pre><code>sudo mount /dev/sda1 /boot  
sudo cp /usr/src/linux/arch/x86_64/boot/bzImage /boot/bzImage.efi  
sudo umount mount /dev/sda1  
</code></pre>
Подготовка загрузочного раздела на этом закончена.
<h2 id="uefi">Настроить прошивку UEFI</h2>
Для того чтобы UEFI мог передать управление нашему ядру, необходимо указать где оно находится. Настройкой параметров прошивки UEFI занимается инструмент под названием <code>efibootmgr</code>:
<pre><code>* sys-boot/efibootmgr
     Available versions:  (~)0.5.4
     Homepage:            http://developer.intel.com/technology/efi
     Description:         Interact with the EFI Boot Manager on IA-64 Systems
</code></pre>
Его необходимо установить, выполнив команду:
<pre><code>echo 'sys-boot/efibootmgr' | sudo tee -a /etc/portage/package.keywords  
sudo emerge sys-boot/efibootmgr  
</code></pre>
После установки выполним настройку UEFI следующей командой:
<pre><code>efibootmgr --create  --label 'Gentoo-3.6.11' --loader '\bzImage.efi' --part 1  
</code></pre>
Подробное описание всех параметров можно посмотреть в man-странице по <code>efibootmgr</code>. Мы используем следующие параметры:
<ul>
	<li><code>--create</code> — создаем новую переменную в загрузчике</li>
	<li><code>--label 'Gentoo-3.6.11'</code> — название которое будет отображаться в списке загрузочных устройств</li>
	<li><code>--loader '\bzImage.efi'</code> — путь к загрузчику, в нашем случае он встроен в ядро, путь абсолютный и с использованием "\"</li>
	<li><code>--part 1</code> — использовать первую партицию блочного устройства sda</li>
</ul>
После выполнения команды будет показан подробный вывод о том какие изменения в UEFI были внесены.
<h2>Перезагрузить систему и проверить результат</h2>
На этом вся настройка завершена и нам осталось перезагрузить систему, предварительно отключив usb-флешку, чтобы посмотреть как система загрузится без использования стороннего загрузчика.

После успешной загрузки системы, пакет загрузчика можно удалять:
<pre><code>grep sys-boot /var/lib/portage/world | xargs emerge -Cv  
</code></pre>
На этом все и можно работать с системой.
<h1 id="genkernel">Обновление ядра средствами genkernel</h1>
При обновлении ядра в будущем, с использованием инструмента <code>genkernel</code>, несколько изменится процедура, т.к. ядро больше не надо инсталлировать в <code>/boot</code>. Поэтому вместо <code>genkernel all</code> необходимо выполнять <code>genkernel kernel</code>, предварительно поправив параметр в значение <code>INSTALL="no"</code> в конфигурации <code>/etc/genkernel.conf</code>. После сборки ядра, его необходимо переименовать и вручную скопировать в каталог <code>/boot</code>.

Процесс обновления в итоге будет выглядеть следующим образом:
<pre><code># sudo genkernel kernel
* Gentoo Linux Genkernel; Version 3.4.45
* Running with options: kernel
...
* Kernel compiled successfully!
...
* Do NOT report kernel bugs as genkernel bugs unless your bug
* is about the default genkernel configuration...
* 
* Make sure you have the latest ~arch genkernel before reporting bugs.

# sudo cp /usr/src/linux/arch/x86_64/boot/bzImage /boot/bzImage.efi
# sudo reboot
</code></pre>
<h1>Итоги</h1>
Плюсы:
<ul>
	<li>отказались от одной прокладки в процессе загрузки ОС</li>
	<li>уменьшилось время загрузки системы</li>
	<li>изучили приемы работы с новым стандартом UEFI, пришедшему на смену BIOS</li>
</ul>
Минусы:
<ul>
	<li>не нашел</li>
</ul>
Источники информации:
<ul>
	<li><a href="http://www.ibm.com/developerworks/ru/library/l-gpt/" target="_blank">Статья о GPT на сайте IBM developerWorks</a></li>
	<li><a href="http://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/plain/Documentation/efi-stub.txt" target="_blank">Документация по EFI-STUB в ядре Linux</a></li>
</ul>