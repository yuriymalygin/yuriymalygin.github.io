---
title: Автоматическая блокировка экрана в GNU/Linux
updated: 2013-02-17 20:48
---

<em>Часто ли уходя за очередной чашечкой кофе или выйдя из кабинета/офиса совершить личный звонок, ты ловишь себя на мысли что забыл заблокировать экран своего компьютера? А на компьютере в это время осталась открытая переписка в Skype/почте или еще хуже — сессия root'а в консоли? В результате ты стараешься вернуться к своему компьютеру как можно быстрее, чтобы добрые коллеги не успели поставить фоном рабочего стола обои с Черным Властелином. В данной статье приведу пример решения этой проблемы с блокировкой экрана, которое поможет закрыть доступ к рабочему столу в тот момент когда ты отойдешь от компьютера.</em>

<!--more-->
<h1>Введение</h1>
Опишу вкратце предлагаемое решение, для понимания того что мы будем сейчас делать. Сделаем так что операционная система будет сама, средствами Bluetooth, проверять как далеко находится пользователь, и в случае «недосягаемости» будет автоматически блокировать экран. Процесс снятия блокировки останется на совести пользователя, и будет заключаться в вводе пароля, который используется в его учетной записи. Автоматически снимать блокировку довольно рискованная затея поэтому данный сценарий рассматривать не будем. По уровню сложности данная статья ориентирована на продвинутых пользователей Linux, т.к. некоторые этапы настройки будут описаны без лишних деталей, полагаясь на очевидность, чтобы не уходить в сторону от основной освещаемой темы.
<h1>Подготовка</h1>
Для начала необходимо убедиться что наш компьютер и мобильный телефон поддерживают технологию Bluetooth. Если с мобильным телефон проблем не должно возникнуть, т.к. большинство современных аппаратов имеют поддержку «синего зуба», то с компьютером вполне могут. Не буду подробно рассказывать как настроить Bluetooth в разных дистрибутивах Linux, а просто опишу основные этапы настройки поддержки оного, при условии что аппаратная часть включает в себя необходимые компоненты, на примере Gentoo.

Основные этапы настройки поддержки Bluetooth в Linux
<ul>
	<li>Включить в BIOS поддержку Bluetooth, если это контролируется отдельным параметром, например как на ноутбуках Lenovo</li>
	<li>Определить какой bluetooth-контроллер используется в конфигурации компьютера:</li>
</ul>
<pre><code>~ $ lsusb | grep -i bluetooth
Bus 001 Device 003: ID 0a5c:217f Broadcom Corp. Bluetooth Controller  
</code></pre>
<ul>
	<li>Включить в ядре поддержку подсистемы Bluetooth и необходимый драйвер для вашего контроллера:</li>
</ul>
<pre><code>Kernel Configuration ---&gt;  
    Bluetooth subsystem support  ---&gt;
        Bluetooth device drivers  ---&gt;
            &lt;*&gt; HCI USB driver
</code></pre>
<ul>
	<li>Сохранить конфигурацию, установить обновленное ядро и его модули, после чего перезагрузить систему для загрузки с новым ядром</li>
	<li>Установить пакет Bluez (с поддержкой test-programs), который будет выполнять работу на программном уровне. В пакетной базе Gentoo он выглядит так:</li>
</ul>
<pre><code>*  net-wireless/bluez
      Latest version available: 4.101-r5
      Latest version installed: [ Not Installed ]
      Size of files: 866 kB
      Homepage:      http://www.bluez.org/
      Description:   Bluetooth Tools and System Daemons for Linux
      License:       GPL-2 LGPL-2.1
</code></pre>
<ul>
	<li>Под пользователем с правами root-а запустить демон bluetooth и добавить его в автозагрузку системы:</li>
</ul>
<pre><code>~ # /etc/init.d/bluetooth start
~ # rc-update add bluetooth default
</code></pre>
<ul>
	<li>Проверить что bluetooth-устройство определилось и готово к работе:</li>
</ul>
<pre><code>~ # hcitool dev
Devices:  
    hci0    CC:52:AF:E3:FB:67

~ # hciconfig list
hci0:    Type: BR/EDR  Bus: USB  
    BD Address: CC:52:AF:E3:FB:67  ACL MTU: 1021:8  SCO MTU: 64:1
    UP RUNNING PSCAN 
...
</code></pre>
На этом подготовка завершена, переходим к следующему этапу.
<h1>Настройка</h1>
В данном разделе будет вся суть решения, а именно мы настроим сопряжение между мобильным телефоном и компьютером. После чего в операционной системе подготовим скрипт проверки доступности телефона по каналу Bluetooth, который будет вызываться каждую минуту средствами демона-планировщика Cron. Приступим.
<ul>
	<li>Включить bluetooth на телефоне и настроить его видимость для остальных участников сети:</li>
<img src="http://gdriv.es/malygin/phone3.jpg"/>
	<li>На стороне компьютера запустить сканирование сети bluetooth, в результате чего мы определим адрес нашего мобильного телефона (можно подсмотреть на самом телефоне):</li>
</ul>
<pre><code>~ # hcitool scan
Scanning ...  
    00:AA:70:31:9A:19    LG-E400
</code></pre>
<ul>
	<li>Настроить сопряжение, на телефоне принять входящее подключение:</li>
</ul>
<pre><code>~ # simple-agent hci0 00:AA:70:31:9A:19
RequestConfirmation (/org/bluez/3522/hci0/dev_00_AA_70_31_9A_19, 724215)  
Confirm passkey (yes/no): yes  
Release  
New device (/org/bluez/3522/hci0/dev_00_AA_70_31_9A_19)  
</code></pre>
<img src="http://gdriv.es/malygin/phone2.jpg"/>
<ul>
	<li>Добавить адрес мобильного телефона в список доверенных устройств:</li>
</ul>
<pre><code>~ # bluez-test-device trusted 00:AA:70:31:9A:19 yes
</code></pre>
<ul>
	<li>Проверить доступность телефона с компьютера по bluetooth:</li>
</ul>
<pre><code>~ # l2ping -c 10 00:AA:70:31:9A:19
</code></pre>
<ul>
	<li>Отключить видимость в настройках bluetooth мобильного телефона, если это не произошло автоматически:</li>
<img src="http://gdriv.es/malygin/phone3.jpg"/>
	<li>Подготовить скрипт, который будет проверять доступность телефона и в случае недоступности блокировать экран:</li>
</ul>
<pre><code>~ # if ! /usr/bin/l2ping -c 1 &lt;%ADDR%&gt; ; then su &lt;%USERNAME%&gt; -c '&lt;%SCREENLOCKER%&gt;' ; fi
</code></pre>
В моем случае: <code>&lt;%ADDR%&gt; = 00:AA:70:31:9A:19</code>, <code>&lt;%USERNAME%&gt;</code> - не root-пользователь, под которым запускаются X и вся остальная основная работа в системе, <code>&lt;%SCREENLOCKER%&gt;</code> - команда блокировки экрана - <code>gnome-screensaver-command --lock</code>. * Выполнить тестовую проверку под root-ом при включенном на телефоне bluetooth * Отключить bluetooth на телефоне и повторно выполнить проверку, тоже с правами root-а * Добавить ежеминутное правило в crontab:
<pre><code>~ # crontab -l
#minute (0-59),
#|    hour (0-23),
#|    |   day of the month (1-31),
#|    |   |   month of the year (1-12),
#|    |   |   |   day of the week (0-6 with 0=Sunday).
#|    |   |   |   |   commands

*    *   *   *   *   export DISPLAY=:0 &amp;&amp; if ! /usr/bin/l2ping -c 1 &lt;%ADDR%&gt; &gt;/dev/null 2&gt;/dev/null ; then su &lt;%USERNAME%&gt; -c '&lt;%SCREENLOCKER%&gt;' ; fi
</code></pre>
Если пугают такие правила в crontab, то можно проверку вынести в отдельный скрипт в каталоге /usr/local/sbin, c более хитрыми проверками, который потом указать в правиле crontab.

На этом настройка и проверка завершены.
<h1>Результат</h1>
Мы получили инструмент, который будет следить за нашим мобильным телефоном и в случае его удаления от компьютера заблокирует экран. В реальных условиях это расстояние не больше 10-20 метров и bluetooth на телефоне должен работать стабильно. Ежедневный ресурс батарейки мобильного телефона несколько уменьшиться, т.к. мы используем короткие подключения по 2-3 секунды.